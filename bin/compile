#!/bin/sh

BUILD_DIR=$1
ENV_DIR=$3
MAGICK_DIR=$BUILD_DIR/.magick

POLICY=<<EOF
<policymap>
<policy domain="resource" name="memory" value="1GiB"/>
<policy domain="resource" name="map" value="2GiB"/>
<policy domain="resource" name="width" value="16KP"/>
<policy domain="resource" name="height" value="16KP"/>
<policy domain="resource" name="area" value="128MB"/>
<policy domain="resource" name="disk" value="4GiB"/>
<policy domain="delegate" rights="none" pattern="URL" />
<policy domain="delegate" rights="none" pattern="HTTPS" />
<policy domain="delegate" rights="none" pattern="HTTP" />
<policy domain="path" rights="none" pattern="@*" />
<policy domain="cache" name="shared-secret" value="passphrase" stealth="true"/>
</policymap>
EOF

export_env_dir() {
  env_dir=$1
  whitelist_regex=${2:-'MAGICK_POLICY_OVERRIDE'}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}

  echo "-----> Exporting env directory for ImageMagick policy buildpack"
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

export_env_dir $ENV_DIR
echo "       ImageMagick override: $MAGICK_POLICY_OVERRIDE"

if [ -f $MAGICK_DIR/policy.xml -a -z "$MAGICK_POLICY_OVERRIDE" ]; then
  echo "-----> Skipping as .magick/policy.xml already exists and no override was requested"
elif [ -f $MAGICK_DIR/policy.xml -a -n "$MAGICK_POLICY_OVERRIDE" ]; then
  echo "-----> Replacing ImageMagick policy file"
  rm $MAGICK_DIR/policy.xml
  cat > $MAGICK_DIR/policy.xml $POLICY
elif [ -n "$MAGICK_POLICY_OVERRIDE" ]; then
  echo "-----> Writing ImageMagick policy file"
  mkdir -p $MAGICK_DIR
  cat > $MAGICK_DIR/policy.xml $POLICY
else
  echo "-----> Skipping and using default policy.xml"
fi
